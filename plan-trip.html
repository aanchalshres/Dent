<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plan Trip - Heritage Portal</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f8f9fa;
      }
      .navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 40px;
        background-color: #8b0000;
        color: #fff;
      }
      .navbar .logo {
        font-weight: bold;
        font-size: 1.5rem;
      }
      .nav-links li a {
        color: #fff;
        text-decoration: none;
        font-weight: 500;
        padding: 8px 12px;
        border-radius: 5px;
      }
      .nav-links li a.active {
        background-color: #ff6347;
      }
      .package-card {
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 15px;
        background: #fff;
        margin-bottom: 20px;
      }
    </style>
  </head>

  <body>
    <!-- Header -->
    <nav class="navbar">
      <div class="logo">
        <a href="/" style="color: white">Heritage Portal</a>
      </div>
      <ul class="nav-links d-flex list-unstyled gap-3">
        <li><a href="index.html">Home</a></li>
        <li><a href="destinations.html">Destinations</a></li>
        <li><a href="heritage-sites.html">Heritage Sites</a></li>
        <li><a href="plan-trip.html" class="active">Plan Trip</a></li>
        <li><a href="events.html">Events</a></li>
      </ul>
    </nav>

    <div class="container mt-5">
      <div id="alertContainer"></div>

      <!-- USER TRIPS TOP -->
      <div id="userTop" class="d-flex justify-content-between mb-3">
        <h2>My Available Trips</h2>
        <button
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#addTripModal"
        >
          Add Trip
        </button>
      </div>

      <!-- TRIP TABLE -->
      <table class="table table-bordered" id="tripTable">
        <thead class="table-dark">
          <tr>
            <th>Select</th>
            <th>Trip Name</th>
            <th>Destination</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- Add Package Button for Admin -->
      <div class="d-flex justify-content-between align-items-center mt-5">
        <h2>Available Packages</h2>
        <button
          id="adminAddPackageBtn"
          class="btn btn-warning d-none"
          data-bs-toggle="modal"
          data-bs-target="#addPackageModal"
        >
          + Add Package
        </button>
      </div>

      <div id="packageContainer" class="row mt-3"></div>

      <!-- User Bookings -->
      <h3 class="mt-5">Your Bookings</h3>
      <div id="bookingSection"><p>No trips booked yet.</p></div>

      <!-- Admin Trips -->
      <div id="adminTripsContainer"></div>
    </div>

    <!-- Add Trip Modal -->
    <div class="modal fade" id="addTripModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Add New Trip</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="tripForm">
              <input
                id="name"
                type="text"
                class="form-control mb-2"
                placeholder="Trip Name"
                required
              />
              <input
                id="startDate"
                type="date"
                required
                class="form-control mb-2"
              />
              <input
                id="endDate"
                type="date"
                required
                class="form-control mb-2"
              />

              <select id="destination" class="form-control mb-2" required>
                <option value="">Select Destination</option>
                <option value="kathmandu">Kathmandu</option>
                <option value="pokhara">Pokhara</option>
                <option value="chitwan">Chitwan</option>
                <option value="bhaktapur">Bhaktapur</option>
              </select>

              <textarea
                id="notes"
                class="form-control mb-2"
                placeholder="Additional Notes"
              ></textarea>

              <button type="submit" class="btn btn-success w-100">
                Add Trip
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Package Modal -->
    <div class="modal fade" id="addPackageModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title">Create New Package</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <form id="packageForm">
              <div class="mb-3">
                <label class="form-label fw-bold">Package Title</label>
                <input
                  type="text"
                  id="pkg_title"
                  class="form-control"
                  required
                />
              </div>

              <div class="mb-3">
                <label class="form-label fw-bold">Description</label>
                <textarea
                  id="pkg_description"
                  class="form-control"
                  rows="3"
                ></textarea>
              </div>

              <div class="mb-3">
                <label class="form-label fw-bold">Price ($)</label>
                <input
                  type="number"
                  id="pkg_price"
                  class="form-control"
                  required
                />
              </div>

              <h5 class="mt-3">Select Trips to Include</h5>

              <div
                id="tripSelectList"
                class="border rounded p-3"
                style="max-height: 250px; overflow-y: auto"
              ></div>

              <button class="btn btn-success w-100 mt-3" type="submit">
                Create Package
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const user = JSON.parse(sessionStorage.getItem("user"));
      if (!user) {
        alert("Please login first!");
        window.location.href = "login.html";
      }

      if (user.role != "admin") {
        document.getElementById("adminAddPackageBtn").style.opacity = 0;
      }

      // ADMIN ONLY UI
      if (user.role === "admin") {
        document.getElementById("userTop").style.display = "none";
        document.getElementById("tripTable").style.display = "none";
        document.querySelector("h3").style.display = "none";
        document.getElementById("bookingSection").style.display = "none";
        document
          .getElementById("adminAddPackageBtn")
          .classList.remove("d-none");
      }

      let bookings =
        JSON.parse(sessionStorage.getItem(`bookings_${user._id}`)) || [];

      const tripTableBody = document.querySelector("#tripTable tbody");
      const bookingSection = document.getElementById("bookingSection");
      const adminTripsContainer = document.getElementById(
        "adminTripsContainer"
      );
      const packageContainer = document.getElementById("packageContainer");

      async function loadData() {
        await loadTrips();
        await loadPackages();
      }

      // ---------------- TRIPS ----------------

      async function loadTrips() {
        const resUser = await fetch(
          `https://dent-vy52.onrender.com/api/trip/user/${user._id}`
        );
        const userTrips = await resUser.json();
        renderUserTrips(userTrips);
        renderBookings();

        if (user.role === "admin") {
          const resAll = await fetch("https://dent-vy52.onrender.com/api/trip/all");
          renderAdminTrips(await resAll.json());
        }
      }

      function renderUserTrips(trips) {
        tripTableBody.innerHTML = "";
        if (!trips.length) {
          tripTableBody.innerHTML = `<tr><td colspan="6">No trips added.</td></tr>`;
          return;
        }

        trips.forEach((trip) => {
          tripTableBody.innerHTML += `
            <tr>
              <td><input type="checkbox" onchange="toggleBooking('${
                trip._id
              }', this.checked)" ${
            bookings.includes(trip._id) ? "checked" : ""
          }></td>
              <td>${trip.name}</td>
              <td>${trip.destination}</td>
              <td>${new Date(trip.startDate).toLocaleDateString()}</td>
              <td>${new Date(trip.endDate).toLocaleDateString()}</td>
              <td>${trip.notes || ""}</td>
            </tr>
          `;
        });
      }

      window.toggleBooking = (id, checked) => {
        if (checked) bookings.push(id);
        else bookings = bookings.filter((b) => b !== id);

        sessionStorage.setItem(
          `bookings_${user._id}`,
          JSON.stringify(bookings)
        );
        renderBookings();
      };

      function renderBookings() {
        bookingSection.innerHTML = "";

        if (!bookings.length) {
          bookingSection.innerHTML = "<p>No trips booked yet.</p>";
          return;
        }

        bookings.forEach((id) => {
          const row = tripTableBody
            .querySelector(
              `input[onchange="toggleBooking('${id}', this.checked)"]`
            )
            .closest("tr");

          bookingSection.innerHTML += `
            <div class="p-3 mb-2 bg-light border rounded">
              <h5>${row.children[1].textContent}</h5>
              <p><strong>Destination:</strong> ${row.children[2].textContent}</p>
              <p><strong>Dates:</strong> ${row.children[3].textContent} - ${row.children[4].textContent}</p>
            </div>
          `;
        });
      }

      function renderAdminTrips(trips) {
        adminTripsContainer.innerHTML = `
          <h3 class="mt-5">All User Trips (Admin View)</h3>
          <table class="table table-bordered">
            <thead class="table-dark">
              <tr>
                <th>User</th>
                <th>Name</th>
                <th>Destination</th>
                <th>Start</th>
                <th>End</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
              ${trips
                .map(
                  (t) => `
              <tr>
                <td>${t.userId.name} (${t.userId.email})</td>
                <td>${t.name}</td>
                <td>${t.destination}</td>
                <td>${new Date(t.startDate).toLocaleDateString()}</td>
                <td>${new Date(t.endDate).toLocaleDateString()}</td>
                <td>${t.notes || ""}</td>
              </tr>`
                )
                .join("")}
            </tbody>
          </table>
        `;
      }

      document
        .getElementById("tripForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const trip = {
            name: document.getElementById("name").value,
            startDate: startDate.value,
            endDate: endDate.value,
            destination: destination.value,
            notes: notes.value,
            userId: user._id,
          };
          console.log(trip);

          const res = await fetch("https://dent-vy52.onrender.com/api/trip/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(trip),
          });

          if (res.ok) {
            bootstrap.Modal.getInstance(addTripModal).hide();
            showAlert("Trip added successfully!");
            loadTrips();
            tripForm.reset();
          } else showAlert("Failed to add trip.");
        });

      // ---------------- PACKAGES ----------------

      async function loadPackages() {
        const res = await fetch("https://dent-vy52.onrender.com/api/package/all");
        const data = await res.json();
        renderPackages(data);
      }

      function renderPackages(packages) {
        packageContainer.innerHTML = "";

        if (!packages.length) {
          packageContainer.innerHTML =
            "<p>No packages available at the moment.</p>";
          return;
        }

        packages.forEach((pkg) => {
          packageContainer.innerHTML += `
            <div class="col-md-4">
              <div class="package-card">
                <h4>${pkg.title}</h4>
                <p><strong>Price:</strong> $${pkg.price}</p>
                <p>${pkg.description}</p>
                <p><strong>Total Trips:</strong> ${pkg.trips.length}</p>

                <button class="btn btn-warning" onclick="bookPackage('${pkg._id}')">
                  Book Package
                </button>
              </div>
            </div>
          `;
        });
      }

      window.bookPackage = async (id) => {
        const res = await fetch("https://dent-vy52.onrender.com/api/package/book", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: user._id, packageId: id }),
        });

        if (res.ok) showAlert("Package booked successfully!");
        else showAlert("Failed to book package.");
      };

      // Load Trips into Package Modal
      async function loadTripsForPackage() {
        const res = await fetch("https://dent-vy52.onrender.com/api/trip/all");
        const trips = await res.json();

        const container = document.getElementById("tripSelectList");
        container.innerHTML = "";

        if (!trips.length) {
          container.innerHTML = "<p>No trips available.</p>";
          return;
        }

        trips.forEach((t) => {
          container.innerHTML += `
            <div class="form-check">
              <input class="form-check-input trip-checkbox" type="checkbox" value="${
                t._id
              }">
              <label class="form-check-label">
                <strong>${t.name}</strong> â€” ${t.destination}
                <br><small>${new Date(
                  t.startDate
                ).toLocaleDateString()} - ${new Date(
            t.endDate
          ).toLocaleDateString()}</small>
              </label>
            </div>
            <hr>
          `;
        });
      }

      document
        .getElementById("addPackageModal")
        .addEventListener("shown.bs.modal", loadTripsForPackage);

      document
        .getElementById("packageForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const selectedTrips = Array.from(
            document.querySelectorAll(".trip-checkbox:checked")
          ).map((c) => c.value);

          if (selectedTrips.length === 0) {
            alert("Please select at least one trip.");
            return;
          }

          const body = {
            title: document.getElementById("pkg_title").value,
            description: document.getElementById("pkg_description").value,
            price: document.getElementById("pkg_price").value,
            trips: selectedTrips,
          };

          const res = await fetch("https://dent-vy52.onrender.com/api/package/add", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${user.token}`,
            },
            body: JSON.stringify(body),
          });

          const data = await res.json();

          if (res.ok) {
            bootstrap.Modal.getInstance(addPackageModal).hide();
            showAlert("Package created successfully!");
            loadPackages();
            packageForm.reset();
          } else {
            showAlert(data.error || "Failed to create package");
          }
        });

      function showAlert(msg) {
        const box = document.getElementById("alertContainer");
        box.innerHTML = `<div class="alert alert-success">${msg}</div>`;
        setTimeout(() => (box.innerHTML = ""), 2000);
      }

      loadData();
    </script>
  </body>
</html>
