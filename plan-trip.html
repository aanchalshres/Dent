<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plan Trip - Heritage Portal</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f8f9fa;
      }
      .navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 40px;
        background-color: #8b0000;
        color: #fff;
      }
      .navbar .logo {
        font-weight: bold;
        font-size: 1.5rem;
      }
      .nav-links {
        list-style: none;
        display: flex;
        gap: 20px;
        margin: 0;
        padding: 0;
      }
      .nav-links li a {
        color: #fff;
        text-decoration: none;
        font-weight: 500;
        padding: 8px 12px;
        border-radius: 5px;
        transition: background-color 0.3s;
      }
      .nav-links li a:hover {
        background-color: #a00000;
      }
      .nav-links li a.active {
        background-color: #ff6347;
      }
      .alert-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: auto;
        z-index: 1000;
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="navbar">
        <div class="logo">
          <a href="/" style="color: white">Heritage Portal</a>
        </div>
        <ul class="nav-links">
          <li><a href="index.html">Home</a></li>
          <li><a href="destinations.html">Destinations</a></li>
          <li><a href="heritage-sites.html">Heritage Sites</a></li>
          <li><a href="plan-trip.html" class="active">Plan Trip</a></li>
          <li><a href="events.html">Events</a></li>
        </ul>
      </nav>
    </header>

    <div class="container mt-5">
      <div class="alert-container" id="alertContainer"></div>

      <!-- User Trips Section -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>My Available Trips</h2>
        <button
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#addTripModal"
        >
          Add Trip
        </button>
      </div>

      <table class="table table-bordered" id="tripTable">
        <thead class="table-dark">
          <tr>
            <th>Select</th>
            <th>Trip Name</th>
            <th>Destination</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <h3 class="mt-5">Your Bookings</h3>
      <div id="bookingSection">
        <p>No trips booked yet.</p>
      </div>

      <!-- Admin Table Section -->
      <div id="adminTripsContainer"></div>
    </div>

    <!-- Add Trip Modal -->
    <div
      class="modal fade"
      id="addTripModal"
      tabindex="-1"
      aria-labelledby="addTripModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="addTripModalLabel">Add New Trip</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="tripForm">
              <input
                type="text"
                id="name"
                placeholder="Trip Name"
                class="form-control mb-2"
                required
              />
              <input
                type="date"
                id="startDate"
                class="form-control mb-2"
                required
              />
              <input
                type="date"
                id="endDate"
                class="form-control mb-2"
                required
              />
              <select id="destination" class="form-control mb-2" required>
                <option value="">Select Destination</option>
                <option value="kathmandu">Kathmandu</option>
                <option value="pokhara">Pokhara</option>
                <option value="chitwan">Chitwan</option>
                <option value="bhaktapur">Bhaktapur</option>
              </select>
              <textarea
                id="notes"
                class="form-control mb-2"
                placeholder="Additional Notes"
              ></textarea>
              <button type="submit" class="btn btn-success w-100">
                Add Trip
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const user = JSON.parse(sessionStorage.getItem("user"));
      if (!user) {
        alert("Please login first!");
        window.location.href = "login.html";
      }

      const tripForm = document.getElementById("tripForm");
      const tripTableBody = document.querySelector("#tripTable tbody");
      const bookingSection = document.getElementById("bookingSection");
      const adminTripsContainer = document.getElementById(
        "adminTripsContainer"
      );

      let bookings =
        JSON.parse(sessionStorage.getItem(`bookings_${user._id}`)) || [];

      async function loadTrips() {
        // Load user trips
        const resUser = await fetch(
          `http://localhost:3000/api/trip/user/${user._id}`
        );
        const userTrips = await resUser.json();
        renderUserTrips(userTrips);
        renderBookings();

        // Load admin table if user is admin
        if (user.role === "admin") {
          const resAll = await fetch("http://localhost:3000/api/trip/all");
          const allTrips = await resAll.json();

          // Filter trips by user role (example: only show trips where user role === 'user')
          const filteredTrips = allTrips.filter(
            (trip) => trip.userId.role === "user"
          );

          renderAdminTrips(filteredTrips);
        }
      }

      function renderUserTrips(trips) {
        tripTableBody.innerHTML = "";
        if (!trips.length) {
          tripTableBody.innerHTML = `<tr><td colspan="6" class="text-center">No trips added.</td></tr>`;
          return;
        }
        trips.forEach((trip) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td><input type="checkbox" onchange="toggleBooking('${
              trip._id
            }', this.checked)" ${
            bookings.includes(trip._id) ? "checked" : ""
          }></td>
            <td>${trip.name}</td>
            <td>${trip.destination}</td>
            <td>${new Date(trip.startDate).toLocaleDateString()}</td>
            <td>${new Date(trip.endDate).toLocaleDateString()}</td>
            <td>${trip.notes || ""}</td>
          `;
          tripTableBody.appendChild(row);
        });
      }

      function renderAdminTrips(trips) {
        adminTripsContainer.innerHTML = `
          <h3 class="mt-5">All User Trips (Admin View)</h3>
          <table class="table table-bordered">
            <thead class="table-dark">
              <tr>
                <th>User</th>
                <th>Trip Name</th>
                <th>Destination</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="adminTripTableBody"></tbody>
          </table>
        `;
        const tbody = document.getElementById("adminTripTableBody");
        trips.forEach((trip) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${trip.userId.name} (${trip.userId.email})</td>
            <td>${trip.name}</td>
            <td>${trip.destination}</td>
            <td>${new Date(trip.startDate).toLocaleDateString()}</td>
            <td>${new Date(trip.endDate).toLocaleDateString()}</td>
            <td>${trip.notes || ""}</td>
          `;
          tbody.appendChild(row);
        });
      }

      // Toggle Booking
      window.toggleBooking = (id, checked) => {
        if (checked) {
          bookings.push(id);
        } else {
          bookings = bookings.filter((b) => b !== id);
        }
        sessionStorage.setItem(
          `bookings_${user._id}`,
          JSON.stringify(bookings)
        );
        renderBookings();
      };

      function renderBookings() {
        bookingSection.innerHTML = "";
        if (!bookings.length) {
          bookingSection.innerHTML = "<p>No trips booked yet.</p>";
          return;
        }
        bookings.forEach((tripId) => {
          const tripRow = tripTableBody.querySelector(
            `input[onchange="toggleBooking('${tripId}', this.checked)"]`
          ).parentNode.parentNode;
          const tripName = tripRow.children[1].textContent;
          const tripDestination = tripRow.children[2].textContent;
          const tripDates = `${tripRow.children[3].textContent} to ${tripRow.children[4].textContent}`;
          const div = document.createElement("div");
          div.className =
            "trip-card mb-2 d-flex justify-content-between align-items-center";
          div.innerHTML = `
            <div>
              <h5>${tripName}</h5>
              <p><strong>Destination:</strong> ${tripDestination}</p>
              <p><strong>Dates:</strong> ${tripDates}</p>
            </div>
          `;
          bookingSection.appendChild(div);
        });
      }

      // Add Trip
      tripForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const trip = {
          name: document.getElementById("name").value,
          startDate: document.getElementById("startDate").value,
          endDate: document.getElementById("endDate").value,
          destination: document.getElementById("destination").value,
          notes: document.getElementById("notes").value,
          userId: user._id,
        };

        const res = await fetch("http://localhost:3000/api/trip/add", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(trip),
        });

        if (res.ok) {
          bootstrap.Modal.getInstance(
            document.getElementById("addTripModal")
          ).hide();
          tripForm.reset();
          showAlert("Trip added successfully!");
          loadTrips();
        } else {
          showAlert("Failed to add trip.");
        }
      });

      function showAlert(msg) {
        const container = document.getElementById("alertContainer");
        const div = document.createElement("div");
        div.className = "alert alert-success text-center";
        div.textContent = msg;
        container.appendChild(div);
        setTimeout(() => div.remove(), 2000);
      }

      loadTrips();
    </script>
  </body>
</html>
