<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Signup</title>
    <!-- Bootstrap CSS CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      .signupbg {
        background-color: #f7f7f7;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .error-label {
        color: red;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
      }
      .card {
        padding: 2rem;
      }
    </style>
  </head>
  <body>
    <div class="signupbg">
      <div class="card w-25 shadow-lg rounded-5">
        <div class="card-body">
          <i class="fa-solid fa-lock fa-2x d-block text-center mt-3"></i>
          <h5 class="text-center text-dark mb-4">Signup</h5>
          <form id="signupForm">
            <div class="mb-3">
              <p id="nameError" class="error-label"></p>
              <input
                class="form-control rounded-3"
                placeholder="Name"
                type="text"
                id="name"
                name="name"
              />
            </div>
            <div class="mb-3">
              <p id="emailError" class="error-label"></p>
              <input
                class="form-control rounded-3"
                placeholder="Email"
                type="email"
                id="email"
                name="email"
              />
            </div>
            <div class="mb-3">
              <p id="passwordError" class="error-label"></p>
              <input
                class="form-control rounded-3"
                placeholder="Password"
                type="password"
                id="password"
                name="password"
              />
            </div>
            <div class="mb-3">
              <input type="file" id="avatar" name="avatar" />
            </div>
            <button type="submit" class="btn btn-danger w-100 rounded-3">
              Sign Up
            </button>
          </form>
        </div>
      </div>
    </div>

    <script>
      const signupForm = document.getElementById("signupForm");
      let avatarPath = "";

      // File upload function
      document
        .getElementById("avatar")
        .addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const fd = new FormData();
          fd.append("myfile", file);

          try {
            const res = await fetch(
              "https://dent-vy52.onrender.com/api/util/uploadfile",
              {
                method: "POST",
                body: fd,
              }
            );
            if (res.status === 200) {
              const data = await res.json();
              avatarPath = data.fileName;
              console.log("File uploaded:", avatarPath);
            } else {
              console.error("File upload failed");
            }
          } catch (err) {
            console.error(err);
          }
        });

      // Validation functions
      function validateName(name) {
        if (!name) return "Name is required";
        if (name.length < 2) return "Too Short!";
        if (name.length > 50) return "Too Long!";
        return "";
      }

      function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email) return "Email is required";
        if (!emailRegex.test(email)) return "Invalid email";
        return "";
      }

      function validatePassword(password) {
        const pwdRegex =
          /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$/;
        if (!password) return "Password is required";
        if (!pwdRegex.test(password))
          return "Must Contain 8 Characters, One Uppercase, One Lowercase, One Number and one special character";
        return "";
      }

      // Form submit
      signupForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const name = document.getElementById("name").value.trim();
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;

        const nameError = validateName(name);
        const emailError = validateEmail(email);
        const passwordError = validatePassword(password);

        document.getElementById("nameError").textContent = nameError;
        document.getElementById("emailError").textContent = emailError;
        document.getElementById("passwordError").textContent = passwordError;

        if (nameError || emailError || passwordError) return;

        const payload = { name, email, password, avatar: avatarPath };
        console.log("Payload:", payload);

        try {
          const res = await fetch("https://dent-vy52.onrender.com/api/user/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (res.status === 200) {
            Swal.fire({
              icon: "success",
              title: "Signup Success",
              text: "Now Login to continue",
            });
            signupForm.reset();
          } else {
            Swal.fire({
              icon: "error",
              title: "Oops!",
              text: "Some Error Occurred",
            });
          }
        } catch (err) {
          console.error(err);
          Swal.fire({
            icon: "error",
            title: "Oops!",
            text: "Network error",
          });
        }
      });
    </script>
  </body>
</html>
