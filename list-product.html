<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product List</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f8f9fa;
      }

      table img {
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
      }

      .alert-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: auto;
        z-index: 1000;
      }

      a {
        color: white;
        text-decoration: none;
      }

      .navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 40px;
        background-color: #8b0000;
        color: #fff;
      }

      .navbar .logo {
        font-weight: bold;
        font-size: 1.5rem;
      }

      .nav-links {
        list-style: none;
        display: flex;
        gap: 20px;
        margin: 0;
        padding: 0;
      }

      .nav-links li a {
        color: #fff;
        text-decoration: none;
        font-weight: 500;
        padding: 8px 12px;
        border-radius: 5px;
        transition: background-color 0.3s;
      }

      .nav-links li a:hover {
        background-color: #a00000;
      }

      .nav-links li a.active {
        background-color: #ff6347;
      }

      @media (max-width: 768px) {
        .navbar {
          flex-direction: column;
          gap: 10px;
        }
        .nav-links {
          flex-direction: column;
          width: 100%;
          align-items: center;
        }
        .nav-links li a {
          width: 100%;
          text-align: center;
        }
      }

      /* Cart Styles */
      .cart-container {
        margin-top: 50px;
      }
      .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #fff;
      }
      .cart-item img {
        width: 50px;
        height: 50px;
        border-radius: 5px;
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="navbar">
        <div class="logo"><a href="/">Heritage Portal</a></div>
        <ul class="nav-links">
          <li><a href="list-product.html">Product List</a></li>
          <li><a href="add-product.html">Add Product</a></li>
          <li><a href="index.html">Home</a></li>
          <li><a href="destinations.html">Destinations</a></li>
        </ul>
      </nav>
    </header>

    <div class="container mt-5">
      <div class="alert-container" id="alertContainer"></div>

      <table
        class="table table-bordered table-hover bg-white"
        id="productTable"
      >
        <thead class="table-warning">
          <tr>
            <th>Image</th>
            <th>Name</th>
            <th>Price</th>
            <th>Category</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <!-- Products will be injected here -->
        </tbody>
      </table>

      <!-- Cart Section -->
      <div class="cart-container">
        <h2>Your Cart</h2>
        <div id="cartItems"></div>
        <h4 id="cartTotal" style="margin-top: 15px">Total Price: ₹0</h4>
        <button
          class="btn btn-success mt-3"
          id="checkoutBtn"
          onclick="checkout()"
        >
          Checkout
        </button>
      </div>
    </div>

    <!-- Update Product Modal -->
    <div
      class="modal fade"
      id="updateModal"
      tabindex="-1"
      aria-labelledby="updateModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title" id="updateModalLabel">Update Product</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="updateForm">
              <input type="hidden" id="updateProductId" />
              <div class="mb-3">
                <label for="updateName" class="form-label">Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="updateName"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="updatePrice" class="form-label">Price</label>
                <input
                  type="number"
                  class="form-control"
                  id="updatePrice"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="updateCategory" class="form-label">Category</label>
                <input
                  type="text"
                  class="form-control"
                  id="updateCategory"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="updateImage" class="form-label">Image URL</label>
                <input type="text" class="form-control" id="updateImage" />
              </div>
              <button type="submit" class="btn btn-primary w-100">
                Update Product
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const user = JSON.parse(sessionStorage.getItem("user"));
      if (!user) {
        // If no user found in sessionStorage, redirect to login page
        alert("Please login first!");
        window.location.href = "login.html"; // Replace with your login page
      }

      if (user.role == "admin") {
        document.querySelector(".cart-container").style.opacity = 0;
      }

      const API_URL = "https://dent-vy52.onrender.com/api/product/getall"; // Get all products
      let products = [];
      let cart = [];

      // Load cart from sessionStorage based on user
      if (user) {
        const savedCart = sessionStorage.getItem(`cart_${user._id}`);
        cart = savedCart ? JSON.parse(savedCart) : [];

        // After loading, render the cart
        renderCart();
      }

      function saveCart() {
        if (user) {
          sessionStorage.setItem(`cart_${user._id}`, JSON.stringify(cart));
        }
      }

      // Fetch products
      async function fetchProducts() {
        try {
          const response = await fetch(API_URL);
          products = await response.json();
          displayProducts(products);
        } catch (error) {
          console.error("Failed to fetch products:", error);
          document.querySelector("#productTable tbody").innerHTML =
            "<tr><td colspan='5'>Failed to load products.</td></tr>";
        }
      }

      // Display products
      function displayProducts(products) {
        const tbody = document.querySelector("#productTable tbody");
        tbody.innerHTML = "";

        if (products.length === 0) {
          tbody.innerHTML = "<tr><td colspan='5'>No Products Found</td></tr>";
          return;
        }


        products.forEach((product) => {
          const url = product.image.startsWith("http") ? product.image : `https://dent-vy52.onrender.com/${product.image}`

          const tr = document.createElement("tr");
          tr.innerHTML = `
                <td><img src="${url}" alt="${
            product.name
          }"></td>
                <td>${product.name}</td>
                <td>रु${product.price}</td>
                <td>${product.category}</td>
                <td>
                  ${
                    user.role != "admin"
                      ? `<button class="btn btn-warning btn-sm" onclick="addToCart('${product._id}')">Add To Cart</button>`
                      : ""
                  }
                  ${
                    user.role == "admin" &&
                    `<button class="btn btn-info btn-sm ms-1" onclick="openUpdateModal('${product._id}')">Update</button>`
                  }
                  ${
                    cart.find((item) => item._id === product._id)
                      ? '<span class="text-success fw-bold ms-2">In Cart</span>'
                      : ""
                  }
                </td>
              `;
          tbody.appendChild(tr);
        });
      }

      // Render product table
      function renderProducts() {
        const tbody = document.querySelector("#productTable tbody");
        tbody.innerHTML = "";

        if (products.length === 0) {
          tbody.innerHTML = "<tr><td colspan='5'>No Products Found</td></tr>";
          return;
        }


        products.forEach((product) => {
          const url = product.image.startsWith("http") ? product.image : `https://dent-vy52.onrender.com/${product.image}`         

          const tr = document.createElement("tr");
          tr.innerHTML = `
              <td><img src="${url}" alt="${
            product.name
          }"></td>
              <td>${product.name}</td>
              <td>रु${product.price}</td>
              <td>${product.category}</td>
              <td>
                <button class="btn btn-warning btn-sm" onclick="addToCart('${
                  product._id
                }')">Add To Cart</button>
                <span class="ms-2">${
                  cart.find((item) => item._id === product._id)
                    ? '<span class="text-success fw-bold">In Cart</span>'
                    : ""
                }</span>
              </td>
            `;
          tbody.appendChild(tr);
        });
      }

      // Add to cart
      function addToCart(productId) {
        const product = products.find((p) => p._id === productId);
        if (!cart.find((item) => item._id === productId)) {
          cart.push({ ...product, quantity: 1 });
          showAlert(`${product.name} added to cart!`);
          displayProducts(products);
          renderCart();
          saveCart();
        }
      }

      // Increase / Decrease quantity
      function updateQuantity(productId, action) {
        cart = cart.map((item) => {
          if (item._id === productId) {
            if (action === "increase")
              return { ...item, quantity: item.quantity + 1 };
            if (action === "decrease")
              return { ...item, quantity: Math.max(item.quantity - 1, 1) };
          }
          return item;
        });
        renderCart();
      }

      // Remove from cart
      function removeFromCart(productId) {
        console.log("Removing cart", productId);
        console.log(cart);
        cart = cart.filter((item) => item._id !== productId);
        renderProducts();
        renderCart();
      }

      // Render cart
      function renderCart() {
        const container = document.getElementById("cartItems");
        container.innerHTML = "";

        let total = 0;

        cart.forEach((item) => {
          total += item.price * item.quantity;
          const div = document.createElement("div");
          div.className = "cart-item";
          div.innerHTML = `
                <div class="d-flex align-items-center">
                  <img src="https://dent-vy52.onrender.com/${item.image}" alt="${item.name}">
                  <div>
                    <h5 style="margin:0;">${item.name}</h5>
                    <p style="margin:0;">रु${item.price} x ${item.quantity}</p>
                  </div>
                </div>
                <div>
                  <button class="btn btn-sm btn-warning" onclick="updateQuantity('${item._id}', 'decrease')">-</button>
                  <button class="btn btn-sm btn-success mx-2" onclick="updateQuantity('${item._id}', 'increase')">+</button>
                  <button class="btn btn-sm btn-danger" onclick="removeFromCart('${item._id}')">Remove</button>
                </div>
              `;
          container.appendChild(div);
        });

        document.getElementById(
          "cartTotal"
        ).textContent = `Total Price: रु${total}`;
      }

      // Checkout
      async function checkout() {
        if (cart.length === 0) {
          showAlert("Your cart is empty!");
          return;
        }

        let user = sessionStorage.getItem("user");
        if (!user) {
          showAlert("Not Logged in");
          return;
        }
        // redirect user directly
        window.location.href = "/checkout.html";
      }

      // Alert
      function showAlert(message) {
        const alertContainer = document.getElementById("alertContainer");
        const alertDiv = document.createElement("div");
        alertDiv.className = "alert alert-success text-center";
        alertDiv.textContent = message;
        alertContainer.appendChild(alertDiv);

        setTimeout(() => {
          alertDiv.remove();
        }, 2000);
      }

      // Update modal
      function openUpdateModal(productId) {
        const product = products.find((p) => p._id === productId);
        document.getElementById("updateProductId").value = product._id;
        document.getElementById("updateName").value = product.name;
        document.getElementById("updatePrice").value = product.price;
        document.getElementById("updateCategory").value = product.category;
        document.getElementById("updateImage").value = product.image;

        const updateModal = new bootstrap.Modal(
          document.getElementById("updateModal")
        );
        updateModal.show();
      }

      document
        .getElementById("updateForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const id = document.getElementById("updateProductId").value;
          const updatedProduct = {
            name: document.getElementById("updateName").value,
            price: Number(document.getElementById("updatePrice").value),
            category: document.getElementById("updateCategory").value,
            image: document.getElementById("updateImage").value,
          };

          try {
            const response = await fetch(
              `https://dent-vy52.onrender.com/api/product/update/${id}`,
              {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(updatedProduct),
              }
            );

            if (response.ok) {
              showAlert("Product updated successfully!");
              fetchProducts();
              bootstrap.Modal.getInstance(
                document.getElementById("updateModal")
              ).hide();
            } else {
              showAlert("Failed to update product.");
            }
          } catch (err) {
            console.error(err);
            showAlert("Error updating product.");
          }
        });

      fetchProducts();
    </script>
  </body>
</html>
